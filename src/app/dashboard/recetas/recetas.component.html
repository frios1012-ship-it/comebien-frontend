<!-- src/app/dashboard/recetas/recetas.component.html -->

<div class="crud-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-info">
      <div class="title-wrapper">
        <mat-icon class="page-icon orange">restaurant_menu</mat-icon>
        <div>
          <h1>{{ isAdmin ? 'Gestión de Recetas' : 'Mis Recetas' }}</h1>
          <p>{{ isAdmin ? 'Administra todas las recetas' : 'Gestiona tus recetas' }}</p>
        </div>
      </div>
      <div class="stats-chip">
        <mat-icon>restaurant_menu</mat-icon>
        <span>{{ recetas.length }} recetas</span>
      </div>
    </div>

    <div class="header-actions">
      <div class="search-box">
        <mat-icon>search</mat-icon>
        <input 
          type="text" 
          placeholder="Buscar recetas..." 
          [(ngModel)]="searchTerm"
          (input)="filterRecetas()">
      </div>

      <button mat-raised-button color="primary" (click)="openForm()" class="new-btn">
        <mat-icon>add</mat-icon>
        <span>Nueva Receta</span>
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-state" *ngIf="loading && !showForm">
    <mat-spinner diameter="48"></mat-spinner>
    <p>Cargando recetas...</p>
  </div>

  <!-- Form Modal -->
  <ng-container *ngIf="showForm">
    <div class="modal-overlay" (click)="closeForm()"></div>
    <div class="modal-container modal-lg">
      <div class="modal-header">
        <div class="modal-title">
          <mat-icon>{{ editMode ? 'edit' : 'restaurant_menu' }}</mat-icon>
          <div>
            <h2>{{ editMode ? 'Editar Receta' : 'Nueva Receta' }}</h2>
            <p>{{ editMode ? 'Modifica los datos de la receta' : 'Crea una nueva receta' }}</p>
          </div>
        </div>
        <button mat-icon-button (click)="closeForm()" class="close-btn">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <form [formGroup]="recetaForm" (ngSubmit)="guardarReceta()" class="modal-body">
        
        <!-- Nombre -->
        <div class="form-group">
          <label>Nombre de la Receta</label>
          <div class="input-field">
            <mat-icon>restaurant</mat-icon>
            <input type="text" formControlName="nombre" placeholder="Ej: Pollo a la plancha">
          </div>
          <span class="field-error" *ngIf="recetaForm.get('nombre')?.invalid && recetaForm.get('nombre')?.touched">
            El nombre es requerido
          </span>
        </div>

        <!-- Tiempo y Calorías -->
        <div class="form-row">
          <div class="form-group">
            <label>Tiempo de Preparación (min)</label>
            <div class="input-field">
              <mat-icon>schedule</mat-icon>
              <input type="number" formControlName="tiempoPreparacion" placeholder="30">
            </div>
            <span class="field-error" *ngIf="recetaForm.get('tiempoPreparacion')?.invalid && recetaForm.get('tiempoPreparacion')?.touched">
              El tiempo es requerido
            </span>
          </div>

          <div class="form-group">
            <label>Calorías Totales</label>
            <div class="input-field">
              <mat-icon>local_fire_department</mat-icon>
              <input type="number" formControlName="caloriasTotales" placeholder="350">
            </div>
            <span class="field-error" *ngIf="recetaForm.get('caloriasTotales')?.invalid && recetaForm.get('caloriasTotales')?.touched">
              Las calorías son requeridas
            </span>
          </div>
        </div>

        <!-- Cliente (solo admin) -->
        <div class="form-group" *ngIf="isAdmin">
          <label>Cliente</label>
          <div class="select-field">
            <mat-icon>person</mat-icon>
            <select formControlName="clienteId">
              <option [ngValue]="null" disabled>Selecciona un cliente</option>
              <option *ngFor="let cliente of clientes" [ngValue]="cliente.id">
                {{ cliente.nombre }}
              </option>
            </select>
            <mat-icon class="arrow-icon">expand_more</mat-icon>
          </div>
        </div>

        <!-- Imagen URL -->
        <div class="form-group">
          <label>Imagen URL (opcional)</label>
          <div class="input-field">
            <mat-icon>image</mat-icon>
            <input type="text" formControlName="imagen" placeholder="https://...">
          </div>
        </div>

        <!-- Ingredientes -->
        <div class="form-section">
          <!-- <CHANGE> Header con botón a la derecha -->
          <div class="section-header">
            <h3><mat-icon>egg</mat-icon> Ingredientes</h3>
            <button type="button" mat-stroked-button color="primary" (click)="agregarIngrediente()" class="add-item-btn">
              <mat-icon>add</mat-icon>
              <span>Agregar</span>
            </button>
          </div>

          <!-- <CHANGE> Lista de ingredientes con layout horizontal -->
          <div class="ingredients-list" formArrayName="ingredientes">
            <div class="ingredient-row" *ngFor="let ing of ingredientesFormArray.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i">
              
              <div class="select-field flex-2">
                <mat-icon>egg</mat-icon>
                <select formControlName="ingredienteId">
                  <option [ngValue]="null" disabled>Seleccionar ingrediente</option>
                  <option *ngFor="let ingrediente of ingredientes" [ngValue]="ingrediente.id">
                    {{ ingrediente.nombre }}
                  </option>
                </select>
              </div>

              <div class="input-field flex-1">
                <mat-icon>scale</mat-icon>
                <input type="number" formControlName="cantidad" placeholder="100">
                <span class="unit-label">g</span>
              </div>

              <button 
                type="button" 
                mat-icon-button 
                color="warn" 
                (click)="eliminarIngredienteForm(i)"
                [disabled]="ingredientesFormArray.length === 1"
                class="remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Instrucciones -->
        <div class="form-group">
          <label>Instrucciones</label>
          <div class="textarea-field">
            <mat-icon>format_list_numbered</mat-icon>
            <textarea formControlName="instrucciones" placeholder="Paso a paso de la preparación..." rows="4"></textarea>
          </div>
          <span class="field-error" *ngIf="recetaForm.get('instrucciones')?.invalid && recetaForm.get('instrucciones')?.touched">
            Las instrucciones son requeridas
          </span>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" mat-stroked-button (click)="closeForm()" class="cancel-btn">
            Cancelar
          </button>

          <!-- Loading state -->
          <button 
            *ngIf="loading" 
            type="button" 
            mat-raised-button 
            color="primary" 
            disabled 
            class="submit-btn">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Guardando...</span>
          </button>

          <!-- Edit mode -->
          <button 
            *ngIf="!loading && editMode" 
            type="submit" 
            mat-raised-button 
            color="primary"
            class="submit-btn">
            <mat-icon>save</mat-icon>
            <span>Guardar</span>
          </button>

          <!-- Create mode -->
          <button 
            *ngIf="!loading && !editMode" 
            type="submit" 
            mat-raised-button 
            color="primary"
            class="submit-btn">
            <mat-icon>add</mat-icon>
            <span>Crear</span>
          </button>
        </div>
      </form>
    </div>
  </ng-container>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!loading && filteredRecetas.length === 0 && !showForm">
    <div class="empty-icon">
      <mat-icon>restaurant_menu</mat-icon>
    </div>
    <h3>No hay recetas registradas</h3>
    <p>Comienza creando tu primera receta</p>

    <button mat-raised-button color="primary" (click)="openForm()" class="new-btn">
      <mat-icon>add</mat-icon>
      <span>Crear Receta</span>
    </button>
  </div>

  <!-- Cards Grid -->
  <div class="cards-grid" *ngIf="!loading && filteredRecetas.length > 0">
    <mat-card class="crud-card" *ngFor="let receta of filteredRecetas; trackBy: trackById">

      <div class="card-header">
        <div class="card-icon orange">
          <mat-icon>restaurant_menu</mat-icon>
        </div>

        <button mat-icon-button [matMenuTriggerFor]="menu" class="menu-btn">
          <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="editarReceta(receta)">
            <mat-icon>edit</mat-icon>
            <span>Editar</span>
          </button>

          <button mat-menu-item *ngIf="isAdmin" (click)="confirmarEliminar(receta)" class="delete-menu-item">
            <mat-icon>delete</mat-icon>
            <span>Eliminar</span>
          </button>
        </mat-menu>
      </div>

      <mat-card-content class="card-body">
        <h3 class="card-title">{{ receta.nombre }}</h3>
        
        <div class="card-meta" *ngIf="isAdmin">
          <mat-icon>person</mat-icon>
          <span>{{ getClienteNombre(receta.clienteId) }}</span>
        </div>

        <div class="card-meta">
          <mat-icon>local_fire_department</mat-icon>
          <span>{{ receta.caloriasTotales }} kcal</span>
        </div>

        <div class="card-meta">
          <mat-icon>schedule</mat-icon>
          <span>{{ receta.tiempoPreparacion }} min</span>
        </div>

        <div class="card-tags" *ngIf="receta.ingredientes && receta.ingredientes.length > 0">
          <span class="tag" *ngFor="let ing of receta.ingredientes.slice(0, 3)">
            {{ getIngredienteNombre(ing.ingredienteId) }}
          </span>
          <span class="tag more" *ngIf="receta.ingredientes.length > 3">
            +{{ receta.ingredientes.length - 3 }}
          </span>
        </div>
      </mat-card-content>

      <div class="card-footer">
        <span class="card-id">#{{ receta.id }}</span>
        <div class="card-actions">
          <button mat-icon-button matTooltip="Editar" (click)="editarReceta(receta)">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Eliminar" *ngIf="isAdmin" (click)="confirmarEliminar(receta)" class="delete-btn">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>

    </mat-card>
  </div>
</div>